<!-- templates/admin_users.html -->
{% extends "admin_base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –ê–¥–º–∏–Ω–∫–∞ EISALS{% endblock %}
{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block admin_content %}
<div class="admin-table-container">
    <div class="table-header">
        <h2>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({{ users|length }})</h2>
        <div class="table-controls">
            <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." class="search-input">
        </div>
    </div>

    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ê–≤–∞—Ç–∞—Ä</th>
                <th>–ò–º—è</th>
                <th>Email</th>
                <th>–†–æ–ª—å</th>
                <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="usersTable">
            {% for user_id, user in users.items() %}
            <tr data-user-id="{{ user_id }}">
                <td>{{ user_id }}</td>
                <td>
                    <img src="{{ url_for('static', filename='users/avas/' ~ user['img_path']) }}"
                         alt="–ê–≤–∞—Ç–∞—Ä" class="table-avatar">
                </td>
                <td>{{ user['name'] }}</td>
                <td>{{ user['email'] }}</td>
                <td>
                    <span class="badge {% if user.get('role') == 'admin' %}badge-admin{% else %}badge-user{% endif %}">
                        {{ user.get('role', 'user') }}
                    </span>
                </td>
                <td>
                    <div class="user-stats">
                        <span title="–ü–æ—Å—Ç—ã">üìù {{ user.get('post_count', 0) }}</span>
                        <span title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">üí¨ {{ user.get('comment_count', 0) }}</span>
                        <span title="–õ–∞–π–∫–∏">‚≠ê {{ user.get('total_likes', 0) }}</span>
                    </div>
                </td>
                <td>
                    {% if user.get('is_active', True) %}
                    <span class="status-active">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                    <span class="status-blocked">‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        {% if user.get('role') != 'admin' %}
                            <button class="btn-admin btn-small"
                                    onclick="makeAdmin('{{ user_id }}')">
                                –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
                            </button>
                        {% endif %}

                        {% if user.get('is_active', True) %}
                            <button class="btn-block btn-small"
                                    onclick="toggleUserStatus('{{ user_id }}')">
                                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        {% else %}
                            <button class="btn-unblock btn-small"
                                    onclick="toggleUserStatus('{{ user_id }}')">
                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        {% endif %}

                        <button class="btn-danger btn-small"
                                onclick="deleteUser('{{ user_id }}')"
                                {% if user_id == session.get('user_id')|string %}disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è"{% endif %}>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.getElementById('userSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tr');

    rows.forEach(row => {
        const name = row.cells[2].textContent.toLowerCase();
        const email = row.cells[3].textContent.toLowerCase();
        const shouldShow = name.includes(searchTerm) || email.includes(searchTerm);
        row.style.display = shouldShow ? '' : 'none';
    });
});

async function makeAdmin(userId) {
    if (!confirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?')) return;

    try {
        const response = await fetch('/api/admin/make_admin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();
        if (data.status === 'success') {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    }
}

async function toggleUserStatus(userId) {
    if (!confirm('–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

    try {
        const response = await fetch('/api/admin/toggle_user_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();
        if (data.status === 'success') {
            alert('–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    }
}

async function deleteUser(userId) {
    if (!confirm('–£–î–ê–õ–ò–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ –ø–æ—Å—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;

    try {
        const response = await fetch('/api/admin/delete_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();
        if (data.status === 'success') {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
    }
}
</script>
{% endblock %}