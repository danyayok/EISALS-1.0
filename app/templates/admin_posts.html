<!-- templates/admin_posts.html -->
{% extends "admin_base.html" %}

{% block title %}Посты - Админка EISALS{% endblock %}
{% block page_title %}Управление постами{% endblock %}

{% block admin_content %}
<div class="admin-table-container">
    <div class="table-header">
        <h2>Все посты ({{ posts|length }})</h2>
        <div class="table-controls">
            <input type="text" id="postSearch" placeholder="Поиск постов..." class="search-input">
        </div>
    </div>

    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Изображение</th>
                <th>Заголовок</th>
                <th>Автор</th>
                <th>Рейтинг</th>
                <th>Комментарии</th>
                <th>Дата</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="postsTable">
            {% for post in posts %}
            <tr data-post-id="{{ post['id'] }}">
                <td>{{ post['id'] }}</td>
                <td>
                    <img src="{{ url_for('static', filename='users/graphs/' ~ post['img_path']) }}"
                         alt="График" class="table-image">
                </td>
                <td>
                    <strong>{{ post['title'][:50] }}{% if post['title']|length > 50 %}...{% endif %}</strong>
                    <p class="post-desc">{{ post['desc'][:100] }}{% if post['desc']|length > 100 %}...{% endif %}</p>
                </td>
                <td>
                    <div class="author-cell">
                        <img src="{{ url_for('static', filename='users/avas/' ~ users[post['author']]['img_path']) }}"
                             alt="Аватар" class="author-avatar">
                        <div>
                            <strong>{{ users[post['author']]['name'] }}</strong>
                            <small>{{ users[post['author']]['email'] }}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="rating-badge {% if post['rating'] > 0 %}rating-positive{% elif post['rating'] < 0 %}rating-negative{% endif %}">
                        {{ post['rating'] }}
                    </span>
                </td>
                <td>{{ post['comms']|length }}</td>
                <td>{{ post['created_at'][:10] }}</td>
                <td>
                    <div class="action-buttons">
                        <a href="/graphs#post-{{ post['id'] }}"
                           class="btn-small btn-view" target="_blank">
                            Просмотр
                        </a>
                        <button class="btn-danger btn-small"
                                onclick="deletePost('{{ post['id'] }}')">
                            Удалить
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Поиск постов
document.getElementById('postSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#postsTable tr');

    rows.forEach(row => {
        const title = row.cells[2].querySelector('strong').textContent.toLowerCase();
        const author = row.cells[3].textContent.toLowerCase();
        const shouldShow = title.includes(searchTerm) || author.includes(searchTerm);
        row.style.display = shouldShow ? '' : 'none';
    });
});

async function deletePost(postId) {
    if (!confirm('УДАЛИТЬ этот пост? Это действие нельзя отменить!')) return;

    try {
        const response = await fetch('/api/admin/delete_any_post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ post_id: postId })
        });

        const data = await response.json();
        if (data.status === 'success') {
            alert('Пост удален!');
            location.reload();
        } else {
            alert('Ошибка: ' + data.message);
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Произошла ошибка');
    }
}
</script>
{% endblock %}